#!/bin/bash
# Project Scratchpad Manager
# Manages project-specific special workspaces in Hyprland

set -euo pipefail

STATE_DIR="$HOME/.local/state/hyprland"
STATE_FILE="$STATE_DIR/current-project"
CONFIG_FILE="$HOME/.config/hypr/projects.conf"
LOG_DIR="$STATE_DIR/project-logs"

# Ensure directories exist
mkdir -p "$STATE_DIR" "$LOG_DIR"

# Get current project (default to first project if not set)
get_current_project() {
    if [[ -f "$STATE_FILE" ]]; then
        cat "$STATE_FILE"
    else
        # Default to first project in config (extract name before colon)
        grep -v '^#' "$CONFIG_FILE" | grep -v '^$' | head -1 | cut -d: -f1
    fi
}

# List all projects from config (just names, not autostart commands)
list_projects() {
    grep -v '^#' "$CONFIG_FILE" | grep -v '^$' | cut -d: -f1
}

# Set current project by index (1-based) - use project-scratchpad-select for full functionality
set_project_by_index() {
    local idx="$1"
    local line
    line=$(grep -v '^#' "$CONFIG_FILE" | grep -v '^$' | sed -n "${idx}p")

    if [[ -z "$line" ]]; then
        notify-send "Project Scratchpad" "Invalid project index: $idx"
        exit 1
    fi

    local project=$(echo "$line" | cut -d: -f1)
    echo "$project" > "$STATE_FILE"
    notify-send "Project Mode" "Switched to: $project"
}

# Toggle current project's scratchpad
toggle_scratchpad() {
    local project
    project=$(get_current_project)

    if [[ -z "$project" ]]; then
        notify-send "Project Scratchpad" "No project configured"
        exit 1
    fi

    hyprctl dispatch togglespecialworkspace "project:$project"
}

# Send current window to project scratchpad
send_to_scratchpad() {
    local project
    project=$(get_current_project)

    if [[ -z "$project" ]]; then
        notify-send "Project Scratchpad" "No project configured"
        exit 1
    fi

    # Log window info before moving
    local window_info=$(hyprctl activewindow -j)
    local title=$(echo "$window_info" | jq -r '.title')
    local class=$(echo "$window_info" | jq -r '.class')
    echo "$(date -Iseconds) | $class | $title" >> "$LOG_DIR/$project.log"

    hyprctl dispatch movetoworkspacesilent "special:project:$project"
}

# View project logs
view_logs() {
    local project="${1:-$(get_current_project)}"
    local follow="${2:-}"
    local log_file="$LOG_DIR/$project.log"

    if [[ ! -f "$log_file" ]]; then
        echo "No logs for project: $project"
        exit 0
    fi

    if [[ "$follow" == "-f" ]]; then
        tail -f "$log_file"
    else
        cat "$log_file"
    fi
}

# Show current project
show_current() {
    local project
    project=$(get_current_project)
    notify-send "Current Project" "$project"
}

# Main command dispatch
case "${1:-toggle}" in
    toggle)
        toggle_scratchpad
        ;;
    send)
        send_to_scratchpad
        ;;
    set)
        set_project_by_index "${2:-1}"
        ;;
    current)
        get_current_project
        ;;
    show)
        show_current
        ;;
    list)
        list_projects
        ;;
    logs)
        view_logs "${2:-}" "${3:-}"
        ;;
    *)
        echo "Usage: project-scratchpad [toggle|send|set <index>|current|show|list|logs [project] [-f]]"
        exit 1
        ;;
esac
