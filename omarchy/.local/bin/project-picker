#!/bin/bash
# Project Picker - CRUD interface for project scratchpads via walker

CONFIG_FILE="$HOME/.config/hypr/projects.conf"

# Get 80% of screen height for walker
SCREEN_HEIGHT=$(hyprctl monitors -j | jq '.[0].height')
WALKER_HEIGHT=$((SCREEN_HEIGHT * 80 / 100))

# Menu actions
ACTION_NEW="âž• New project"
ACTION_DELETE="ðŸ—‘ï¸ Delete project"
ACTION_EDIT="âœï¸ Edit config"
SEPARATOR="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Extract just project names (first field before pipe)
get_projects() {
    grep -v '^#' "$CONFIG_FILE" | grep -v '^$' | cut -d'|' -f1
}

# Build menu with projects + actions
build_menu() {
    get_projects
    echo "$SEPARATOR"
    echo "$ACTION_NEW"
    echo "$ACTION_DELETE"
    echo "$ACTION_EDIT"
}

# Prompt for text input via walker
prompt_input() {
    local prompt="$1"
    echo "" | omarchy-launch-walker --dmenu --width 400 --minheight 1 --maxheight 1 -p "$prompt" 2>/dev/null
}

# Browse for directory using walker
browse_directory() {
    # Find directories from common locations
    local dirs=""
    local search_paths=("$HOME/dev" "$HOME/projects" "$HOME/work")

    for path in "${search_paths[@]}"; do
        if [[ -d "$path" ]]; then
            dirs+=$(fd --type d --max-depth 3 --exclude .git --exclude node_modules --exclude .cache --exclude __pycache__ --exclude venv --exclude .venv . "$path" 2>/dev/null)
            dirs+=$'\n'
        fi
    done

    # Filter, sort, and select with walker
    echo "$dirs" | grep -v '^$' | sort -u | omarchy-launch-walker --dmenu --width 600 --minheight 1 --maxheight "$WALKER_HEIGHT" -p "ðŸ“‚ Select directory:" 2>/dev/null
}

# Create new project
create_project() {
    # Step 1: Select directory first (most important)
    local project_dir
    project_dir=$(browse_directory)
    [[ -z "$project_dir" ]] && exit 0

    # Step 2: Auto-suggest name from directory basename
    local suggested_name
    suggested_name=$(basename "$project_dir" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

    local name
    name=$(echo "$suggested_name" | omarchy-launch-walker --dmenu --width 400 --minheight 1 --maxheight 1 -p "Project name:" 2>/dev/null)
    [[ -z "$name" ]] && name="$suggested_name"

    # Validate: no pipes, alphanumeric + dashes/underscores
    if [[ ! "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        notify-send "Project Picker" "Invalid name. Use only letters, numbers, - and _"
        exit 1
    fi

    # Check if already exists
    if grep -q "^${name}|" "$CONFIG_FILE"; then
        notify-send "Project Picker" "Project '$name' already exists"
        exit 1
    fi

    # Auto-detect tmux session: look for existing session matching directory name
    local tmux_session="$name"
    local existing_sessions
    existing_sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null || true)
    if [[ -n "$existing_sessions" ]]; then
        local matching
        matching=$(echo "$existing_sessions" | grep -i "$(basename "$project_dir")" | head -1 || true)
        [[ -n "$matching" ]] && tmux_session="$matching"
    fi

    # Create the project
    echo "${name}|${tmux_session}|${project_dir}" >> "$CONFIG_FILE"
    notify-send "Project Picker" "Created: $name â†’ $tmux_session"

    # Switch to the new project
    project-scratchpad-select "$(get_projects | grep -n "^${name}$" | cut -d: -f1)"
}

# Delete project
delete_project() {
    local projects
    projects=$(get_projects)

    [[ -z "$projects" ]] && notify-send "Project Picker" "No projects to delete" && exit 0

    local selected
    selected=$(echo "$projects" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight "$WALKER_HEIGHT" -p "Delete which?" 2>/dev/null)

    [[ -z "$selected" ]] && exit 0

    # Confirm deletion
    local confirm
    confirm=$(printf "Yes, delete\nNo, cancel" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight 2 -p "Delete '$selected'?" 2>/dev/null)

    [[ "$confirm" != "Yes, delete" ]] && exit 0

    # Remove from config (matches lines starting with "project|")
    sed -i "/^${selected}|/d" "$CONFIG_FILE"
    notify-send "Project Picker" "Deleted: $selected"
}

# Edit config in editor
edit_config() {
    # Try zed first, fall back to nvim in terminal
    if command -v zed &>/dev/null; then
        uwsm-app -- zed "$CONFIG_FILE"
    elif command -v nvim &>/dev/null; then
        uwsm-app -- ghostty -e nvim "$CONFIG_FILE"
    else
        uwsm-app -- ghostty -e nano "$CONFIG_FILE"
    fi
}

# Main picker
main() {
    local selected
    selected=$(build_menu | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight "$WALKER_HEIGHT" -p "Projectâ€¦" 2>/dev/null)

    case "$selected" in
        "$ACTION_NEW")
            create_project
            ;;
        "$ACTION_DELETE")
            delete_project
            ;;
        "$ACTION_EDIT")
            edit_config
            ;;
        "$SEPARATOR"|"")
            exit 0
            ;;
        *)
            # Regular project selection
            local idx
            idx=$(get_projects | grep -n "^${selected}$" | cut -d: -f1)
            if [[ -n "$idx" ]]; then
                project-scratchpad-select "$idx"
            fi
            ;;
    esac
}

main
