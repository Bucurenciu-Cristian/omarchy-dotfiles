#!/bin/bash
# Project Picker - CRUD interface for project scratchpads via walker

CONFIG_FILE="$HOME/.config/hypr/projects.conf"

# Get 80% of screen height for walker
SCREEN_HEIGHT=$(hyprctl monitors -j | jq '.[0].height')
WALKER_HEIGHT=$((SCREEN_HEIGHT * 80 / 100))

# Menu actions
ACTION_NEW="‚ûï New project"
ACTION_TOGGLE="üîÑ Toggle status"
ACTION_DELETE="üóëÔ∏è Delete project"
ACTION_EDIT="‚úèÔ∏è Edit config"
SEPARATOR="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Status indicators
STATUS_ACTIVE="‚óè"
STATUS_PENDING="‚óã"

# Extract just project names (first field before pipe)
get_projects() {
    grep -v '^#' "$CONFIG_FILE" | grep -v '^$' | cut -d'|' -f1
}

# Get projects with status, grouped: Active first, then Pending
# Config format: name|session|dir|status (status defaults to "active" if missing)
# Shows workspace number for easy window targeting
get_projects_with_status() {
    local active=""
    local pending=""
    local idx=0

    while IFS='|' read -r name session dir status; do
        [[ -z "$name" ]] && continue
        ((idx++))
        # Default to "active" if status field is missing (backwards compat)
        [[ -z "$status" ]] && status="active"
        if [[ "$status" == "active" ]]; then
            active+="$idx $STATUS_ACTIVE $name"$'\n'
        else
            pending+="$idx $STATUS_PENDING $name"$'\n'
        fi
    done < <(grep -v '^#' "$CONFIG_FILE" | grep -v '^$')

    # Output Active first, then Pending (no headers, just grouped)
    echo -n "$active"
    echo -n "$pending"
}

# Extract project name from "idx status name" format
strip_status() {
    echo "$1" | sed 's/^[0-9]* [‚óè‚óã] //'
}

# Extract index from "idx status name" format
get_selection_idx() {
    echo "$1" | cut -d' ' -f1
}

# Build menu with projects + actions
build_menu() {
    get_projects_with_status
    echo "$SEPARATOR"
    echo "$ACTION_NEW"
    echo "$ACTION_TOGGLE"
    echo "$ACTION_DELETE"
    echo "$ACTION_EDIT"
}

# Prompt for text input via walker
prompt_input() {
    local prompt="$1"
    echo "" | omarchy-launch-walker --dmenu --width 400 --minheight 1 --maxheight 1 -p "$prompt" 2>/dev/null
}

# Special directory options
DIR_CUSTOM="üìù Enter custom path"
DIR_NONE="üöÄ No folder yet"

# Browse for directory using walker
browse_directory() {
    # Find directories from common locations
    local dirs=""
    local search_paths=("$HOME/dev" "$HOME/projects" "$HOME/work")

    for path in "${search_paths[@]}"; do
        if [[ -d "$path" ]]; then
            dirs+=$(fd --type d --max-depth 3 --exclude .git --exclude node_modules --exclude .cache --exclude __pycache__ --exclude venv --exclude .venv . "$path" 2>/dev/null)
            dirs+=$'\n'
        fi
    done

    # Add special options at the top, then existing directories
    {
        echo "$DIR_CUSTOM"
        echo "$DIR_NONE"
        echo "$SEPARATOR"
        echo "$dirs" | grep -v '^$' | sort -u
    } | omarchy-launch-walker --dmenu --width 600 --minheight 1 --maxheight "$WALKER_HEIGHT" -p "üìÇ Select directory:" 2>/dev/null
}

# Create new project
create_project() {
    # Step 1: Select directory (or special option)
    local project_dir
    local selection
    selection=$(browse_directory)
    [[ -z "$selection" || "$selection" == "$SEPARATOR" ]] && exit 0

    # Handle special options
    case "$selection" in
        "$DIR_CUSTOM")
            # Prompt for custom path
            project_dir=$(prompt_input "Enter path:")
            [[ -z "$project_dir" ]] && exit 0
            # Expand ~ to home directory
            project_dir="${project_dir/#\~/$HOME}"
            ;;
        "$DIR_NONE")
            # Use ~/dev as placeholder
            project_dir="$HOME/dev"
            ;;
        *)
            project_dir="$selection"
            ;;
    esac

    # Step 2: Auto-suggest name from directory basename (or prompt if ~/dev placeholder)
    local suggested_name
    if [[ "$selection" == "$DIR_NONE" ]]; then
        suggested_name=""
    else
        suggested_name=$(basename "$project_dir" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
    fi

    local name
    name=$(echo "$suggested_name" | omarchy-launch-walker --dmenu --width 400 --minheight 1 --maxheight 1 -p "Project name:" 2>/dev/null)
    [[ -z "$name" ]] && name="$suggested_name"

    # Validate: no pipes, alphanumeric + dashes/underscores
    if [[ ! "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        notify-send "Project Picker" "Invalid name. Use only letters, numbers, - and _"
        exit 1
    fi

    # Check if already exists
    if grep -q "^${name}|" "$CONFIG_FILE"; then
        notify-send "Project Picker" "Project '$name' already exists"
        exit 1
    fi

    # Auto-detect tmux session: look for existing session matching directory name
    local tmux_session="$name"
    local existing_sessions
    existing_sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null || true)
    if [[ -n "$existing_sessions" ]]; then
        local matching
        matching=$(echo "$existing_sessions" | grep -i "$(basename "$project_dir")" | head -1 || true)
        [[ -n "$matching" ]] && tmux_session="$matching"
    fi

    # Create the project (default status: active)
    echo "${name}|${tmux_session}|${project_dir}|active" >> "$CONFIG_FILE"
    notify-send "Project Picker" "Created: $name ‚Üí $tmux_session"

    # Switch to the new project
    $HOME/.local/bin/project-scratchpad-select "$(get_projects | grep -n "^${name}$" | cut -d: -f1)"
}

# Delete project
delete_project() {
    local projects
    projects=$(get_projects_with_status)

    [[ -z "$projects" ]] && notify-send "Project Picker" "No projects to delete" && exit 0

    local selected
    selected=$(echo "$projects" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight "$WALKER_HEIGHT" -p "Delete which?" 2>/dev/null)

    [[ -z "$selected" ]] && exit 0

    # Strip status prefix
    local project_name
    project_name=$(strip_status "$selected")

    # Confirm deletion
    local confirm
    confirm=$(printf "Yes, delete\nNo, cancel" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight 2 -p "Delete '$project_name'?" 2>/dev/null)

    [[ "$confirm" != "Yes, delete" ]] && exit 0

    # Remove from config (matches lines starting with "project|")
    sed -i "/^${project_name}|/d" "$CONFIG_FILE"
    notify-send "Project Picker" "Deleted: $project_name"
}

# Toggle project status between active/pending
toggle_status() {
    local projects
    projects=$(get_projects_with_status)

    [[ -z "$projects" ]] && notify-send "Project Picker" "No projects" && exit 0

    local selected
    selected=$(echo "$projects" | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight "$WALKER_HEIGHT" -p "Toggle which?" 2>/dev/null)

    [[ -z "$selected" ]] && exit 0

    # Strip status prefix to get project name
    local project_name
    project_name=$(strip_status "$selected")

    # Get current line and determine new status
    local current_line
    current_line=$(grep "^${project_name}|" "$CONFIG_FILE")
    [[ -z "$current_line" ]] && exit 1

    # Parse current status (field 4, default to "active")
    local current_status
    current_status=$(echo "$current_line" | cut -d'|' -f4)
    [[ -z "$current_status" ]] && current_status="active"

    # Toggle status
    local new_status
    if [[ "$current_status" == "active" ]]; then
        new_status="pending"
    else
        new_status="active"
    fi

    # Build new line with updated status
    local name session dir
    name=$(echo "$current_line" | cut -d'|' -f1)
    session=$(echo "$current_line" | cut -d'|' -f2)
    dir=$(echo "$current_line" | cut -d'|' -f3)
    local new_line="${name}|${session}|${dir}|${new_status}"

    # Replace in config (use # as delimiter to avoid escaping pipes)
    sed -i "s#^${project_name}|.*#${new_line}#" "$CONFIG_FILE"
    notify-send "Project Picker" "$project_name ‚Üí $new_status"
}

# Edit config in editor
edit_config() {
    # Try zed first, fall back to nvim in terminal
    if command -v zed &>/dev/null; then
        uwsm-app -- zed "$CONFIG_FILE"
    elif command -v nvim &>/dev/null; then
        uwsm-app -- ghostty -e nvim "$CONFIG_FILE"
    else
        uwsm-app -- ghostty -e nano "$CONFIG_FILE"
    fi
}

# Main picker
main() {
    local selected
    selected=$(build_menu | omarchy-launch-walker --dmenu --width 295 --minheight 1 --maxheight "$WALKER_HEIGHT" -p "Project‚Ä¶" 2>/dev/null)

    case "$selected" in
        "$ACTION_NEW")
            create_project
            ;;
        "$ACTION_TOGGLE")
            toggle_status
            ;;
        "$ACTION_DELETE")
            delete_project
            ;;
        "$ACTION_EDIT")
            edit_config
            ;;
        "$SEPARATOR"|"")
            exit 0
            ;;
        *)
            # Regular project selection - get index directly from selection
            local idx
            idx=$(get_selection_idx "$selected")
            if [[ -n "$idx" && "$idx" =~ ^[0-9]+$ ]]; then
                $HOME/.local/bin/project-scratchpad-select "$idx"
            fi
            ;;
    esac
}

main
