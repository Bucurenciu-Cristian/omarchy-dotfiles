#!/bin/bash
#
# toplex - Transfer media files to Plex server
#
# Usage:
#   toplex <file_or_folder>           # Transfer to root of plex-media (prompts for target)
#   toplex -t <file_or_folder>        # Transfer to plex-media/tv/
#   toplex -m <file_or_folder>        # Transfer to plex-media/movies/
#   toplex -d <subdir> <file_or_folder>  # Transfer to plex-media/<subdir>/
#   toplex --scan                     # Trigger Plex library scan (uses last target or prompts)
#   toplex -l [subdir]                # List plex-media contents (prompts for target)
#
# Targets:
#   ubuntu (remote) - SSH + rsync transfer to remote Plex server
#   local (omarchy) - Local sudo mv to /usr/lib/plexmediaserver/
#

set -e

# Configuration
TARGETS=("ubuntu" "local")
REMOTE_HOST="ubuntu"
REMOTE_BASE="/mnt/external-hdd/plex-media"
LOCAL_BASE="/usr/lib/plexmediaserver"
LOCAL_DEFAULT="$HOME/qbit"
REMOTE_PLEX_TOKEN="_QFuhwDHU3HoVPUw1eQY"
LOCAL_PLEX_TOKEN="<your_local_plex_token>"
STATE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/toplex/last-target"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Prompt user to select a target
prompt_target() {
    echo -e "${BLUE}Select target:${NC}" >&2
    echo "  1) ubuntu (remote)" >&2
    echo "  2) local" >&2
    echo -n "Choice [1-2]: " >&2
    read -r choice
    case $choice in
        1) echo "ubuntu" ;;
        2) echo "local" ;;
        *)
            echo -e "${RED}Invalid choice. Defaulting to ubuntu.${NC}" >&2
            echo "ubuntu"
            ;;
    esac
}

# Save last used target to state file
save_target_state() {
    local target="$1"
    mkdir -p "$(dirname "$STATE_FILE")"
    echo "$target" > "$STATE_FILE"
}

# Read last used target from state file
read_target_state() {
    if [[ -f "$STATE_FILE" ]]; then
        cat "$STATE_FILE"
    else
        echo ""
    fi
}

usage() {
    echo -e "${BLUE}toplex${NC} - Transfer media to Plex server"
    echo ""
    echo "Usage:"
    echo "  toplex <file_or_folder>              Transfer to plex-media root (prompts for target)"
    echo "  toplex -t <file_or_folder>           Transfer to plex-media/tv/"
    echo "  toplex -m <file_or_folder>           Transfer to plex-media/movies/"
    echo "  toplex -d <subdir> <file_or_folder>  Transfer to plex-media/<subdir>/"
    echo "  toplex --scan                        Trigger Plex library scan (uses last target)"
    echo "  toplex -l [subdir]                   List plex-media contents (prompts for target)"
    echo "  toplex --dry-run <args>              Show what would be transferred"
    echo ""
    echo "Targets:"
    echo "  ubuntu (remote) - SSH + rsync transfer to remote Plex server"
    echo "  local (omarchy) - Local sudo mv to /usr/lib/plexmediaserver/"
    echo ""
    echo "Examples:"
    echo "  toplex Movie.Name.2024.mkv"
    echo "  toplex -t 'Show.Name.S01.Complete/'"
    echo "  toplex -m -d 'Action' Movie.mkv"
}

list_contents() {
    local target="$1"
    local subdir="${2:-}"

    if [[ "$target" == "ubuntu" ]]; then
        echo -e "${BLUE}Contents of ${REMOTE_HOST}:${REMOTE_BASE}/${subdir}:${NC}"
        ssh "$REMOTE_HOST" "ls -lh '${REMOTE_BASE}/${subdir}' 2>/dev/null || echo 'Directory empty or does not exist'"
    elif [[ "$target" == "local" ]]; then
        echo -e "${BLUE}Contents of ${LOCAL_BASE}/${subdir}:${NC}"
        ls -lh "${LOCAL_BASE}/${subdir}" 2>/dev/null || echo 'Directory empty or does not exist'
    else
        echo -e "${RED}Unknown target: ${target}${NC}"
        return 1
    fi
}

trigger_scan() {
    local target
    target=$(read_target_state)

    if [[ -z "$target" ]]; then
        echo -e "${YELLOW}No previous transfer found. Which Plex server to scan?${NC}"
        target=$(prompt_target)
    fi

    echo -e "${YELLOW}Triggering Plex library scan on ${target}...${NC}"

    if [[ "$target" == "ubuntu" ]]; then
        ssh "$REMOTE_HOST" "curl -s -X POST 'http://localhost:32400/library/sections/all/refresh?X-Plex-Token=${REMOTE_PLEX_TOKEN}'" && {
            echo -e "${GREEN}Scan triggered on ${target}!${NC}"
            return 0
        }
    elif [[ "$target" == "local" ]]; then
        curl -s -X POST "http://localhost:32400/library/sections/all/refresh?X-Plex-Token=${LOCAL_PLEX_TOKEN}" && {
            echo -e "${GREEN}Scan triggered on ${target}!${NC}"
            return 0
        }
    else
        echo -e "${RED}Unknown target: ${target}${NC}"
        return 1
    fi

    echo -e "${YELLOW}Auto-scan failed. Scan manually in Plex UI.${NC}"
}

transfer() {
    local source="$1"
    local dest_subdir="$2"
    local dry_run="$3"
    local target="$4"

    # Resolve source path
    if [[ ! -e "$source" ]]; then
        # Try relative to LOCAL_DEFAULT
        if [[ -e "${LOCAL_DEFAULT}/${source}" ]]; then
            source="${LOCAL_DEFAULT}/${source}"
        else
            echo -e "${RED}Error: File or folder not found: ${source}${NC}"
            exit 1
        fi
    fi

    if [[ "$target" == "ubuntu" ]]; then
        transfer_remote "$source" "$dest_subdir" "$dry_run"
    elif [[ "$target" == "local" ]]; then
        transfer_local "$source" "$dest_subdir" "$dry_run"
    else
        echo -e "${RED}Unknown target: ${target}${NC}"
        exit 1
    fi

    # Save target state for --scan
    if [[ "$dry_run" != "true" ]]; then
        save_target_state "$target"
    fi
}

transfer_remote() {
    local source="$1"
    local dest_subdir="$2"
    local dry_run="$3"

    local dest_path="${REMOTE_BASE}"
    [[ -n "$dest_subdir" ]] && dest_path="${REMOTE_BASE}/${dest_subdir}"

    # Ensure remote directory exists
    echo -e "${BLUE}Ensuring remote directory exists: ${dest_path}${NC}"
    ssh "$REMOTE_HOST" "mkdir -p '${dest_path}'"

    # Build rsync command
    local rsync_opts="-avz --progress --human-readable"
    [[ "$dry_run" == "true" ]] && rsync_opts="$rsync_opts --dry-run"

    echo -e "${GREEN}Transferring:${NC} $(basename "$source")"
    echo -e "${GREEN}To:${NC} ${REMOTE_HOST}:${dest_path}/"
    echo ""

    rsync $rsync_opts "$source" "${REMOTE_HOST}:${dest_path}/"

    if [[ "$dry_run" != "true" ]]; then
        echo ""
        echo -e "${BLUE}Setting ownership to plex:plex...${NC}"
        ssh -t "$REMOTE_HOST" "sudo chown -R plex:plex '${dest_path}'" 2>/dev/null || \
            echo -e "${YELLOW}Warning: Could not chown to plex. You may need to run: ssh -t ubuntu 'sudo chown -R plex:plex ${dest_path}'${NC}"
        echo -e "${GREEN}Transfer complete!${NC}"
        echo -e "${YELLOW}Tip: Run 'toplex --scan' to update Plex library${NC}"
    fi
}

transfer_local() {
    local source="$1"
    local dest_subdir="$2"
    local dry_run="$3"

    local dest_path="${LOCAL_BASE}"
    [[ -n "$dest_subdir" ]] && dest_path="${LOCAL_BASE}/${dest_subdir}"

    echo -e "${GREEN}Transferring:${NC} $(basename "$source")"
    echo -e "${GREEN}To:${NC} ${dest_path}/"
    echo ""

    if [[ "$dry_run" == "true" ]]; then
        echo -e "${YELLOW}[DRY RUN] Would run:${NC}"
        echo "  sudo mkdir -p '${dest_path}'"
        echo "  sudo mv '${source}' '${dest_path}/'"
        echo "  sudo chown -R plex:plex '${dest_path}'"
    else
        # Ensure local directory exists
        echo -e "${BLUE}Ensuring local directory exists: ${dest_path}${NC}"
        sudo mkdir -p "${dest_path}"

        # Move file/folder
        sudo mv "$source" "${dest_path}/"

        # Set ownership
        echo -e "${BLUE}Setting ownership to plex:plex...${NC}"
        sudo chown -R plex:plex "${dest_path}" 2>/dev/null || \
            echo -e "${YELLOW}Warning: Could not chown to plex.${NC}"

        echo -e "${GREEN}Transfer complete!${NC}"
        echo -e "${YELLOW}Tip: Run 'toplex --scan' to update Plex library${NC}"
    fi
}

# Parse arguments
DEST_SUBDIR=""
DRY_RUN="false"
SOURCE=""
LIST_SUBDIR=""
DO_LIST="false"

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        -t|--tv)
            DEST_SUBDIR="tv"
            shift
            ;;
        -m|--movies)
            DEST_SUBDIR="movies"
            shift
            ;;
        -d|--dir)
            DEST_SUBDIR="$2"
            shift 2
            ;;
        -l|--list)
            DO_LIST="true"
            LIST_SUBDIR="${2:-}"
            shift
            [[ $# -gt 0 && ! "$1" =~ ^- ]] && { LIST_SUBDIR="$1"; shift; }
            ;;
        --scan)
            trigger_scan
            exit 0
            ;;
        --dry-run)
            DRY_RUN="true"
            shift
            ;;
        *)
            SOURCE="$1"
            shift
            ;;
    esac
done

# Handle list command
if [[ "$DO_LIST" == "true" ]]; then
    TARGET=$(prompt_target)
    list_contents "$TARGET" "$LIST_SUBDIR"
    exit 0
fi

if [[ -z "$SOURCE" ]]; then
    usage
    exit 1
fi

# Prompt for target before transfer
TARGET=$(prompt_target)
transfer "$SOURCE" "$DEST_SUBDIR" "$DRY_RUN" "$TARGET"
