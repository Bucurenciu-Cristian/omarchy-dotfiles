#!/bin/bash
#
# toplex - Transfer media files to Plex server
#
# Usage:
#   toplex <file_or_folder>           # Transfer to root of plex-media (uses last target)
#   toplex -t <file_or_folder>        # Transfer to plex-media/tv/
#   toplex -m <file_or_folder>        # Transfer to plex-media/movies/
#   toplex -d <subdir> <file_or_folder>  # Transfer to plex-media/<subdir>/
#   toplex --scan                     # Trigger Plex library scan (uses last target or prompts)
#   toplex -l [subdir]                # List plex-media contents (uses last target)
#
# Target Selection:
#   -r, --remote     Use ubuntu (remote) target, save as default
#   -L, --local      Use local target, save as default
#   --pick           Force interactive target prompt, save choice as default
#   (no flag)        Use last target from state file, prompt on first run
#
# Targets:
#   ubuntu (remote) - SSH + rsync transfer to remote Plex server
#   local (omarchy) - Local sudo mv to /usr/lib/plexmediaserver/
#
# Configuration:
#   Create ~/.config/toplex/config with:
#     REMOTE_PLEX_TOKEN="your_remote_token_here"
#     LOCAL_PLEX_TOKEN="your_local_token_here"
#

set -e
set -u

# Configuration
TOPLEX_CONFIG="${XDG_CONFIG_HOME:-$HOME/.config}/toplex/config"
REMOTE_HOST="ubuntu"
REMOTE_BASE="/mnt/external-hdd/plex-media"
LOCAL_BASE="/usr/lib/plexmediaserver"
LOCAL_DEFAULT="$HOME/qbit"
STATE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/toplex/last-target"

# Token defaults (will be overridden by config file)
REMOTE_PLEX_TOKEN=""
LOCAL_PLEX_TOKEN=""

# Source config file if it exists
if [[ -f "$TOPLEX_CONFIG" ]]; then
    # shellcheck source=/dev/null
    source "$TOPLEX_CONFIG"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Prompt user to select a target
prompt_target() {
    # Check if stdin is a terminal
    if [[ ! -t 0 ]]; then
        echo -e "${RED}Error: Cannot prompt for target - stdin is not a terminal.${NC}" >&2
        echo -e "${RED}Use explicit target options or run interactively.${NC}" >&2
        exit 1
    fi

    echo -e "${BLUE}Select target:${NC}" >&2
    echo "  1) ubuntu (remote)" >&2
    echo "  2) local" >&2
    echo -n "Choice [1-2]: " >&2
    read -r choice
    case $choice in
        1) echo "ubuntu" ;;
        2) echo "local" ;;
        *)
            echo -e "${RED}Invalid choice. Defaulting to ubuntu.${NC}" >&2
            echo "ubuntu"
            ;;
    esac
}

# Save last used target to state file
save_target_state() {
    local target="$1"
    mkdir -p "$(dirname "$STATE_FILE")"
    echo "$target" > "$STATE_FILE"
}

# Read last used target from state file
read_target_state() {
    if [[ -f "$STATE_FILE" ]]; then
        cat "$STATE_FILE"
    else
        echo ""
    fi
}

# Get target based on flags, state file, or prompt
# Uses global variables: TARGET, FORCE_PICK
get_target() {
    local target=""

    # If TARGET already set by flag (-r/--remote or -L/--local), use it
    if [[ -n "${TARGET:-}" ]]; then
        target="$TARGET"
    # If --pick flag set, force interactive prompt
    elif [[ "${FORCE_PICK:-}" == "true" ]]; then
        target=$(prompt_target)
    else
        # Try to read from state file
        target=$(read_target_state)
        # If state file empty/missing, prompt
        if [[ -z "$target" ]]; then
            target=$(prompt_target)
        fi
    fi

    # Save the target to state file
    save_target_state "$target"

    echo "$target"
}

usage() {
    echo -e "${BLUE}toplex${NC} - Transfer media to Plex server"
    echo ""
    echo "Usage:"
    echo "  toplex <file_or_folder>              Transfer to plex-media root (uses last target)"
    echo "  toplex -t <file_or_folder>           Transfer to plex-media/tv/"
    echo "  toplex -m <file_or_folder>           Transfer to plex-media/movies/"
    echo "  toplex -d <subdir> <file_or_folder>  Transfer to plex-media/<subdir>/"
    echo "  toplex --scan                        Trigger Plex library scan (uses last target)"
    echo "  toplex -l [subdir]                   List plex-media contents (uses last target)"
    echo "  toplex --dry-run <args>              Show what would be transferred"
    echo ""
    echo "Target Selection:"
    echo "  -r, --remote   Use ubuntu (remote) target, save as default"
    echo "  -L, --local    Use local target, save as default"
    echo "  --pick         Force interactive target prompt, save choice as default"
    echo "  (no flag)      Use last target from state file, prompt on first run"
    echo ""
    echo "Targets:"
    echo "  ubuntu (remote) - SSH + rsync transfer to remote Plex server"
    echo "  local (omarchy) - Local sudo mv to /usr/lib/plexmediaserver/"
    echo ""
    echo "Configuration:"
    echo "  Create ${TOPLEX_CONFIG} with:"
    echo "    REMOTE_PLEX_TOKEN=\"your_remote_token_here\""
    echo "    LOCAL_PLEX_TOKEN=\"your_local_token_here\""
    echo ""
    echo "Examples:"
    echo "  toplex -t show.mkv           Uses last target (ubuntu or local)"
    echo "  toplex -r -t show.mkv        Forces ubuntu, saves as default"
    echo "  toplex -L -t show.mkv        Forces local, saves as default"
    echo "  toplex --pick -t show.mkv    Prompts, saves choice as default"
    echo "  toplex -l                    Lists using last target"
    echo "  toplex -l --pick             Lists after prompting for target"
}

list_contents() {
    local target="$1"
    local subdir="${2:-}"

    if [[ "$target" == "ubuntu" ]]; then
        echo -e "${BLUE}Contents of ${REMOTE_HOST}:${REMOTE_BASE}/${subdir}:${NC}"
        ssh "$REMOTE_HOST" "ls -lh '${REMOTE_BASE}/${subdir}' 2>/dev/null || echo 'Directory empty or does not exist'"
    elif [[ "$target" == "local" ]]; then
        echo -e "${BLUE}Contents of ${LOCAL_BASE}/${subdir}:${NC}"
        ls -lh "${LOCAL_BASE}/${subdir}" 2>/dev/null || echo 'Directory empty or does not exist'
    else
        echo -e "${RED}Unknown target: ${target}${NC}"
        return 1
    fi
}

trigger_scan() {
    local target
    target=$(read_target_state)

    if [[ -z "$target" ]]; then
        echo -e "${YELLOW}No previous transfer found. Which Plex server to scan?${NC}"
        target=$(prompt_target)
    fi

    echo -e "${YELLOW}Triggering Plex library scan on ${target}...${NC}"

    if [[ "$target" == "ubuntu" ]]; then
        # Validate remote token
        if [[ -z "$REMOTE_PLEX_TOKEN" || "$REMOTE_PLEX_TOKEN" == "your_remote_token_here" ]]; then
            echo -e "${RED}Error: REMOTE_PLEX_TOKEN not configured.${NC}" >&2
            echo -e "${RED}Please set it in ${TOPLEX_CONFIG}${NC}" >&2
            return 1
        fi
        if ssh "$REMOTE_HOST" "curl -s -X POST 'http://localhost:32400/library/sections/all/refresh?X-Plex-Token=${REMOTE_PLEX_TOKEN}'"; then
            echo -e "${GREEN}Scan triggered on ${target}!${NC}"
            return 0
        else
            echo -e "${YELLOW}Auto-scan failed. Scan manually in Plex UI.${NC}"
            return 1
        fi
    elif [[ "$target" == "local" ]]; then
        # Validate local token
        if [[ -z "$LOCAL_PLEX_TOKEN" || "$LOCAL_PLEX_TOKEN" == "your_local_token_here" ]]; then
            echo -e "${RED}Error: LOCAL_PLEX_TOKEN not configured.${NC}" >&2
            echo -e "${RED}Please set it in ${TOPLEX_CONFIG}${NC}" >&2
            return 1
        fi
        if curl -s -X POST "http://localhost:32400/library/sections/all/refresh?X-Plex-Token=${LOCAL_PLEX_TOKEN}"; then
            echo -e "${GREEN}Scan triggered on ${target}!${NC}"
            return 0
        else
            echo -e "${YELLOW}Auto-scan failed. Scan manually in Plex UI.${NC}"
            return 1
        fi
    else
        echo -e "${RED}Unknown target: ${target}${NC}"
        return 1
    fi
}

transfer() {
    local source="$1"
    local dest_subdir="$2"
    local dry_run="$3"
    local target="$4"

    # Resolve source path
    if [[ ! -e "$source" ]]; then
        # Try relative to LOCAL_DEFAULT
        if [[ -e "${LOCAL_DEFAULT}/${source}" ]]; then
            source="${LOCAL_DEFAULT}/${source}"
        else
            echo -e "${RED}Error: File or folder not found: ${source}${NC}"
            exit 1
        fi
    fi

    if [[ "$target" == "ubuntu" ]]; then
        transfer_remote "$source" "$dest_subdir" "$dry_run"
    elif [[ "$target" == "local" ]]; then
        transfer_local "$source" "$dest_subdir" "$dry_run"
    else
        echo -e "${RED}Unknown target: ${target}${NC}"
        exit 1
    fi

    # Save target state for --scan
    if [[ "$dry_run" != "true" ]]; then
        save_target_state "$target"
    fi
}

transfer_remote() {
    local source="$1"
    local dest_subdir="$2"
    local dry_run="$3"

    local dest_path="${REMOTE_BASE}"
    [[ -n "$dest_subdir" ]] && dest_path="${REMOTE_BASE}/${dest_subdir}"

    # Ensure remote directory exists
    echo -e "${BLUE}Ensuring remote directory exists: ${dest_path}${NC}"
    ssh "$REMOTE_HOST" "mkdir -p '${dest_path}'"

    # Build rsync command with array
    local rsync_opts=(-avz --progress --human-readable)
    [[ "$dry_run" == "true" ]] && rsync_opts+=(--dry-run)

    echo -e "${GREEN}Transferring:${NC} $(basename "$source")"
    echo -e "${GREEN}To:${NC} ${REMOTE_HOST}:${dest_path}/"
    echo ""

    rsync "${rsync_opts[@]}" "$source" "${REMOTE_HOST}:${dest_path}/"

    if [[ "$dry_run" != "true" ]]; then
        echo ""
        echo -e "${BLUE}Setting ownership to plex:plex...${NC}"
        ssh -t "$REMOTE_HOST" "sudo chown -R plex:plex '${dest_path}'" 2>/dev/null || \
            echo -e "${YELLOW}Warning: Could not chown to plex. You may need to run: ssh -t ubuntu 'sudo chown -R plex:plex ${dest_path}'${NC}"
        echo -e "${GREEN}Transfer complete!${NC}"
        echo -e "${YELLOW}Tip: Run 'toplex --scan' to update Plex library${NC}"
    fi
}

transfer_local() {
    local source="$1"
    local dest_subdir="$2"
    local dry_run="$3"

    local dest_path="${LOCAL_BASE}"
    [[ -n "$dest_subdir" ]] && dest_path="${LOCAL_BASE}/${dest_subdir}"

    echo -e "${GREEN}Transferring:${NC} $(basename "$source")"
    echo -e "${GREEN}To:${NC} ${dest_path}/"
    echo ""

    if [[ "$dry_run" == "true" ]]; then
        echo -e "${YELLOW}[DRY RUN] Would run:${NC}"
        echo "  sudo mkdir -p '${dest_path}'"
        echo "  sudo mv '${source}' '${dest_path}/'"
        echo "  sudo chown -R plex:plex '${dest_path}'"
    else
        # Ensure local directory exists
        echo -e "${BLUE}Ensuring local directory exists: ${dest_path}${NC}"
        sudo mkdir -p "${dest_path}"

        # Move file/folder
        sudo mv "$source" "${dest_path}/"

        # Set ownership
        echo -e "${BLUE}Setting ownership to plex:plex...${NC}"
        sudo chown -R plex:plex "${dest_path}" 2>/dev/null || \
            echo -e "${YELLOW}Warning: Could not chown to plex.${NC}"

        echo -e "${GREEN}Transfer complete!${NC}"
        echo -e "${YELLOW}Tip: Run 'toplex --scan' to update Plex library${NC}"
    fi
}

# Parse arguments
DEST_SUBDIR=""
DRY_RUN="false"
SOURCE=""
LIST_SUBDIR=""
DO_LIST="false"
TARGET=""
FORCE_PICK="false"

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        -r|--remote)
            TARGET="ubuntu"
            shift
            ;;
        -L|--local)
            TARGET="local"
            shift
            ;;
        --pick)
            FORCE_PICK="true"
            shift
            ;;
        -t|--tv)
            DEST_SUBDIR="tv"
            shift
            ;;
        -m|--movies)
            DEST_SUBDIR="movies"
            shift
            ;;
        -d|--dir)
            DEST_SUBDIR="$2"
            shift 2
            ;;
        -l|--list)
            DO_LIST="true"
            shift
            if [[ $# -gt 0 && ! "$1" =~ ^- ]]; then
                LIST_SUBDIR="$1"
                shift
            fi
            ;;
        --scan)
            trigger_scan
            exit 0
            ;;
        --dry-run)
            DRY_RUN="true"
            shift
            ;;
        *)
            SOURCE="$1"
            shift
            ;;
    esac
done

# Handle list command
if [[ "$DO_LIST" == "true" ]]; then
    TARGET=$(get_target)
    list_contents "$TARGET" "$LIST_SUBDIR"
    exit 0
fi

if [[ -z "$SOURCE" ]]; then
    usage
    exit 1
fi

# Get target (from flag, state file, or prompt) before transfer
TARGET=$(get_target)
transfer "$SOURCE" "$DEST_SUBDIR" "$DRY_RUN" "$TARGET"
